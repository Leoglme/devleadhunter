name: ðŸš€ Deploy FastAPI (server/) to VPS

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - 'server/requirements.txt'
      - '.github/workflows/deploy-server.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'server/**'
      - 'server/requirements.txt'
  workflow_dispatch:

concurrency:
  group: fastapi-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: ðŸ—ï¸ Deploy API
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout (sparse)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            server
          lfs: false

      - name: ðŸ§­ Debug workspace
        run: |
          pwd
          ls -la
          ls -la server || true
          cat .git/info/sparse-checkout || true
          find server -type f || true
          test -f server/requirements.txt && echo "requirements.txt exists" || echo "requirements.txt missing"

      - name: ðŸ§± Ensure target structure (SSH)
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            TARGET_DIR="/var/www/api.devleadhunter.dibodev.fr/html"
            sudo mkdir -p "$TARGET_DIR"
            sudo rm -rf "$TARGET_DIR/server"
            sudo mkdir -p "$TARGET_DIR/server"
            sudo mkdir -p "$TARGET_DIR/.venv"
            sudo chown -R $USER:$USER "$TARGET_DIR"

      - name: ðŸ“¤ Upload server sources (SCP)
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          strip_components: 0
          source: "server"
          target: /var/www/api.devleadhunter.dibodev.fr/html

      - name: ðŸ Create/Update venv & install deps (SSH)
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            TARGET_DIR="/var/www/api.devleadhunter.dibodev.fr/html"
            cd "$TARGET_DIR"
            # Add MySQL GPG key
            sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys B7B3B788A8D3785C || true
            # Remove Docker repository
            if [ -f /etc/apt/sources.list.d/docker.list ]; then
              sudo rm -f /etc/apt/sources.list.d/docker.list
            fi
            # Update APT with error tolerance
            sudo apt-get update -y --allow-releaseinfo-change || true
            sudo apt-get install -y python3-venv
            # Debug requirements.txt
            ls -la server/requirements.txt || echo "requirements.txt missing"
            # Create or update virtual environment
            if [ ! -x ".venv/bin/python" ]; then
              python3 -m venv .venv
            fi
            . .venv/bin/activate
            python -m pip install --upgrade pip wheel
            pip install -r server/requirements.txt --no-cache-dir
            deactivate

      - name: âš™ï¸ Create .env file (SSH)
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            TARGET_DIR="/var/www/api.devleadhunter.dibodev.fr/html"
            cd "$TARGET_DIR/server"
            cat > .env <<EOF
            ENV=production
            DEBUG=false
            API_VERSION=v1
            API_PREFIX=/api/v1
            HOST=127.0.0.1
            PORT=8005
            CORS_ORIGINS=http://localhost:3000,http://localhost:5173
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
            ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            ACCESS_TOKEN_EXPIRE_MINUTES=30
            EOF
            echo ".env file created/updated successfully"
            cat .env

      - name: ðŸ—„ï¸ Run database initialization (SSH)
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            TARGET_DIR="/var/www/api.devleadhunter.dibodev.fr/html"
            cd "$TARGET_DIR/server"
            ../.venv/bin/python init_db.py

      - name: âš™ï¸ Configure/restart systemd service (SSH)
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            TARGET_DIR="/var/www/api.devleadhunter.dibodev.fr/html"
            SERVICE_NAME="devleadhunter-api.service"
            DEPLOY_USER="${{ secrets.SSH_USERNAME }}"
            sudo bash -c "cat > /etc/systemd/system/${SERVICE_NAME}" <<EOF
            [Unit]
            Description=DevLeadHunter FastAPI (Uvicorn)
            After=network.target
            [Service]
            User=${DEPLOY_USER}
            WorkingDirectory=${TARGET_DIR}/server
            Environment=PYTHONPATH=${TARGET_DIR}/server
            ExecStart=${TARGET_DIR}/.venv/bin/uvicorn main:app --host 127.0.0.1 --port 8005 --workers 1 --proxy-headers
            Restart=always
            RestartSec=5
            KillSignal=SIGINT
            # Memory limits to prevent OOM kills
            MemoryMax=2G
            MemoryHigh=1.5G
            [Install]
            WantedBy=multi-user.target
            EOF
            sudo systemctl daemon-reload
            sudo systemctl enable ${SERVICE_NAME}
            sudo systemctl restart ${SERVICE_NAME}
            sudo systemctl --no-pager --full status ${SERVICE_NAME} || true

      - name: ðŸ”„ Test & reload Nginx (SSH)
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            sudo nginx -t
            sudo systemctl reload nginx

