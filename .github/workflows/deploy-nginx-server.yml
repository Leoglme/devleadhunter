name: ðŸ”„ Deploy Nginx Server Configuration
on:
  push:
    paths:
      - 'nginx/nginx-server.conf'
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-nginx-server:
    name: ðŸ”„ DÃ©ployer configuration Nginx Serveur
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            nginx/nginx-server.conf
          sparse-checkout-cone: true

      - name: ðŸ“¤ Deploy nginx server config to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: 'nginx/nginx-server.conf'
          target: '/tmp'
          strip_components: 1

      - name: ðŸ”§ Move nginx config to sites-enabled and reload
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |            
            # Copie de la nouvelle config
            sudo cp /tmp/nginx-server.conf /etc/nginx/sites-enabled/api.devleadhunter.dibodev.fr
            
            # Test de la configuration
            sudo nginx -t
            
            # Rechargement de nginx si le test est OK
            sudo systemctl reload nginx
            
            # Nettoyage
            rm /tmp/nginx-server.conf
            
            echo "âœ… Configuration Nginx Serveur dÃ©ployÃ©e et rechargÃ©e avec succÃ¨s !"
            sudo nginx -T | grep "server_name api.devleadhunter.dibodev.fr" -A 5
